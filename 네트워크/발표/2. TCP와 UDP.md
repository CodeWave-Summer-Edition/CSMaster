# TCP, UDP

*전송 계층에서 데이터를 보내기 위해 사용하는 프로토콜*

- table of contents

# I. TCP(Transmission Control Protocol)

- 데이터를 안정적으로 전송하기 위해 설계됨
- IP와 함께 사용되어 신뢰성 있는 통신을 제공하며, 대부분의 인터넷 통신에서 사용됨

## TCP의 특징

- 연결 지향 방식으로, 데이터 전송을 시작하기 전에 수신자와 송신자 간 연결을 먼저 설정
- 패킷 교환 방식을 사용하며, 모든 데이터 패킷이 올바른 순서대로 수신되도록 보장
- 모든 정보가 정확하고 순서대로 전달되어야 하는 웹 서버, 이메일 서비스, 파일 전송 등 애플리케이션에 적합
- 혼잡 제어
    
    ```
    혼잡 제어 매커니즘
    
    1. 혼잡 검출
        - 네트워크에 혼잡이 발생하면 패킷이 손실 및 지연이 발생할 수 있음
        - TCP는 이를 방지하기 위해 패킷 손실 및 대기 시간을 모니터링함
    2. 윈도우 크기 조절
        - 혼잡이 발생하면 TCP는 윈도우 크기를 동적으로 조절하여 송신 속도를 낮춤
        - 작은 윈도우 크기로 패킷을 송신하여 네트워크 혼잡 완화
    3. 타임아웃 및 재전송
        - 혼잡으로 인해 패킷이 손실될 경우, TCP는 타임아웃을 설정하고 해당 패킷을 재전송
    4. 흐름 제어
        - 수신측이 송신측에게 자신의 처리 속도보다 느린 속도로 데이터를 전송하도록 지시하는 기능
        - 이를 통해 네티워크 혼잡을 피하고 안정적인 통신을 유지
    ```
    
- 전이중, 점대점 방식
    
    ```
    전이중 통신 (Full Duplex)
    
    - 양쪽이 동시에 데이터를 주고받을 수 있는 양방향 통신
    - 예) 전화 통화
    
    점대점 방식 (Point to Point)
    
    - 한 대의 송신자와 한 대의 수신자 간 통신
    - 예 ) 집 컴퓨터 → 회사 서버로 직접 파일 전송
    ```
    

### 장점

- 데이터의 순서를 보장하므로, 신뢰성 있는 데이터 전송이 가능함
- 재전송 매커니즘을 통해 패킷 손실 방지

### 단점

- 연결 설정 및 종료 과정으로 인해 느린 속도
- 패킷 손실 발생 시 재전송을 통해 속도가 더욱 느려질 수 있음

## TCP의 데이터 전송 과정

### 1. 3-way Handshake 를 통한 연결 설정 (Connection Establishment)

데이터 전송을 시작하기 전 수신자와의 연결을 설정
[3-Way Handshake & 4-Way Handshake](https://velog.io/@khu147/handshake)

1. Client → Server (SYN)
    - 클라이언트가 서버에게 통신을 시작하겠다는 메세지를 보냄
    - 메세지에는 SYN 이라는 플래그가 설정되어 있음
    - 클라이언트는 초기 sequence number를 랜덤하게 선택하여 전송
2. Server → Client (SYN-ACK)
    - 서버가 클라이언트에게 SYN-ACK 메시지로 응답
    - 메세지에는 SYN, ACK(Acknowledgement) 플래그가 설정되어있음
    - 서버는 클라이언트의 초기 sequence number에 1을 더한 값을 자신의 초기 시퀀스 번호로 선택
3. Client → Server (ACK)
    - 클라이언트는 서버에게 ACK 메시지를 보냄
    - 메세지에는 ACK 플래그가 설정되어 있음
    - 클라이언트는 서버의 초기 sequence number에 1을 더한 값을 자신의 초기 sequence number로 선택

### 2. 데이터 전송 (Data Transfer)

- 송신자는 데이터 패킷을 수신자에게 전송
    
    ```
    패킷이란?
    
    라우팅(= 데이터를 보내기 위한 경로 찾기)을 효율적으로 하기 위해 데이터를 여러 조각으로 나누어 전송하는데, 이 조각이 패킷임
    
    패킷의 구성
    
    1. 헤더 (Header)
        - 출발지와 목적지 주소
        - 프로토콜 정보 (i.e. TCP, UDP, IMCP 등)
        - 헤더 길이
        - Checksum
        - 기타 옵션 → 페이지 하단
    2. 페이로드 (Payload)
        - 실제 전송하려는 데이터가 담겨있음
    3. 트레일러 (Trailer)
        - 오류 검출을 위해 사용될 수 있음
        - CRC 등의 값을 포함하여 데이터 무결성을 확인
    ```
    
- 각 패킷은 고유한 sequence number를 갖고 있어, 수신자가 패킷을 올바른 순서로 재조립할 수 있음

### 3. 수신 확인 (Acknowledgement)

- 수신자가 수신된 패킷을 확인하기 위해 ACK 패킷을 송신자에게 전송
    - ACK는 마지막으로 성공적으로 수신된 패킷의 sequence number를 포함
- 대조를 통해 송신자가 어떤 패킷이 성공적으로 도착했는지 알 수 있음

### 4. 재전송 (Retransmission)

- ACK가 도착하지 않으면 송신자는 해당 패킷이 손실되었다고 판단
- 패킷을 재전송

### 5. 4-way Handshake를 통한 연결 해제 (Connection Termination)

1. Client → Server (FIN)
    - 통신을 종료하고자 하는 클라이언트가 서버에거 FIN(Finish) 메세지 전송
    - 이를 전송함으로써 클라이언트가 더이상 데이터를 보내지 않겠다는 것을 나타냄
2. Server → Client (ACK)
    - 서버는 클라이언트의 FIN 메시지에 대해 ACK를 보내 확인
    - 서버는 클라이언트의 데이터 전송이 끝났음을 알게 됨
    - 그러나 아직 서버는 클라이언트에게 데이터를 보낼 수 있음
    (이 때 남은 데이터 전송)
3. Server → Client (FIN)
    - 서버는 통신을 종료하겠다는 의미로 FIN 메시지를 클라이언트에게 전송
    - 즉, 서버도 더이상 데이터를 보내지 않겠다
4. Client → Server (ACK)
    - 클라이언트는 서버의 FIN 메시지에 대한 응답으로 ACK 메시지를 보냄
    - 클라이언트도 서버의 데이터 전송이 끝났음을 알게 됨

# II. UDP(User Datagram Protocol)

- 데이터를 신속하게 전송하는 데 사용됨
- 주로 실시간 응용 프로그램에서 많이 사용

## UDP의 특징

- 비연결성 : 연결을 설정하지 않고 데이터를 전송
- 신뢰성 부족
    - 데이터 전송의 정확성을 보장하지 않음
    - 오류 검사는 있으나, 오류 발생 시 복구 기능이 부족해 손실 또는 오류 발생 시 애플리케이션에서 처리해야 함
        
        ```
        Checksum
        
        *UDP의 주요 오류 검사 방식*
        
        **동작 과정**
        
        1. 송신자
            - UDP 패킷의 헤더와 데이터를 합쳐서 Checksum 을 계산
            - 계산된 Checksum 값을 UDP 헤더에 추가
        2. 수신자
            - 받은 UDP 패킷의 헤더와 데이터를 합쳐서 Checksum 값 계산
            - 계산된 Checksum 값과 패킷 헤더의 Checksum 값 비교
        3. 오류 검출
            - Checksum 값이 일치하면 데이터에 오류가 없다고 가정하고 처리
            - 일치하지 않으면 데이터에 오류가 있을 가능성이 높으며, 이 때 오류를 처리하는 방법은 애플리케이션에 따라 상이
        ```
        
- 고속 전송 : TCP보다 light weighted, 연결 설정 및 제어 매커니즘이 없어서 더 빠른 속도로 데이터를 전송
- 멀티캐스트, 브로드캐스트 지원 → 여러 대의 수신자에게 동시에 데이터 전송 가능
    
    ```
    멀티캐스트(Multicast)
    
    - 그룹 지정 : 특정 그룹에 속한 멤버들에게만 데이터 전송
    - IP 주소 범위 : 224.0.0.0 ~ 239.255.255.255
    - 효율성 : 네트워크 대역폭을 효과적으로 활용해 여러대의 컴퓨터에 데이터 전송 가능
    
    브로드캐스트(Broadcast)
    
    - 모든 장치에 전송 : 네트워크에 연결된 모든 장치에게 전달
    - 네트워크 부하 : 대규모 네트워크에서 브로드캐스트를 남용하면 부하가 발생할 수 있음
    - 유한 범위 : 일반적으로 로컬 네트워크 내에서만 유효하며, 라우터를 통해 다른 네트워크로 전파되지 않음
    - 보안 이슈를 유발할 수 있음
    
    *현대에는 보다 효율적인 통신을 위해 브로드캐스트를 최소화하고 멀티캐스트 또는 유니캐스트(단일 대상에게 전송)을 선호*

    ```
    

### 장점

- 빠른 속도 : 연결 설정이 없고 오버헤드가 적어 빠른 데이터 전송이 가능함
- 간편성 : 높은 처리 속도와 간편한 구현으로 실시간 응용 프로그램에서 많이 사용
- 멀티캣트 및 브로드캐스트 지원

### 단점

- 신뢰성 부족 : 오류 발생 시 복구가 제한적, 데이터의 정확성 보장 X
- 순서 보장 부족 : 데이터의 전송 순서가 보장되지 않아, 순서가 중요한 응용 프로그램에는 부적함

## UDP의 데이터 전송 과정

### 1. 데이터 송신

1. 데이터 생성 : 송신자에서 전송하고자 하는 데이터 생성
2. UDP 패킷 생성
    - 생성된 데이터에 UDP 프로토콜의 헤더를 붙여서 UDP 패킷 생성
    - 송신지와 목적지의 포트 번호, 길이 등 정보가 들어있음
3. Checksum 계산 : UDP 패킷의 헤더와 데이터를 합쳐서 Checksum 값을 계산하고, UDP 헤더에 추가함
4. 소켓 송신 : UDP 패킷을 송신하기 위해 운영체제의 소켓 인터페이스에 전달
5. 네트워크 전송 : 네트워크를 통해 UDP 패킷을 수신자(서버 또는 다른 호스트)로 전송

### 2. 데이터 수신

1. UDP 패킷 수신 : 네트워크를 통해 도착한 UDP 패킷은 수신자의 소켓 인터페이스를 통해 수신
2. Checksum 확인 : 수신자는 받은 UDP 패킷의 헤더와 데이터를 합쳐 Checksum 값 계산
3. Checksum 일치 여부 판단
    - 송신자가 계산한 Checksum 값과 수신자가 계산한 Checksum 값을 비교
    - 일치할 경우 데이터가 손상되지 않았다고 판단
4. 데이터 추출 : Checksum 이 일치하면 UDP 패킷에서 실제 데이터와 헤더 추출



<details>    
  <summary> 패킷 헤더의 기타 옵션에는 무엇이 들어갈 수 있는가? </summary>
    
    1. TCP (Transmission Control Protocol)
    
    - 윈도우 크기 (Window Size) : 수신자가 송신자에게 한 번에 받을 수 있는 최대 데이터 양을 나타냅니다.
    - 순서 번호 (Sequence Number) 및 확인 응답 번호 (Acknowledgment Number) : 패킷의 순서를 식별하고, 수신자가 받은 최신 패킷의 순서를 알려줍니다.
    - URG (Urgent) : 긴급 데이터가 포함되어 있음을 나타냅니다.
    - ACK (Acknowledgment) : 확인 응답 번호가 유효함을 나타냅니다.
    - PSH (Push) : 데이터가 버퍼에 쌓이지 말고 즉시 전달되어야 함을 나타냅니다.
    - RST (Reset) : 연결 초기화를 나타냅니다.
    - SYN (Synchronize) : 연결 설정을 초기화하기 위해 사용됩니다.
    - FIN (Finish) : 송신자가 더 이상 데이터를 전송하지 않을 것임을 나타냅니다.
    
    2. IP (Internet Protocol)
    
    - TTL (Time To Live) : 패킷이 라우터를 몇 번이나 거치는지를 나타내는 값으로, 네트워크에서 무한 루프를 방지합니다.
    - DSCP (Differentiated Services Code Point) : 서비스 품질에 대한 정보를 제공하며, 네트워크에서 특정 유형의 서비스에 우선권을 부여할 수 있습니다.
    
    3. ICMP (Internet Control Message Protocol)
    
    - Echo Request 및 Echo Reply : 핑(Ping) 테스트에서 사용되며, 네트워크 상태를 확인하는 데 사용됩니다.
    - Time Exceeded : TTL이 0이 되었을 때 라우터에 의해 생성되며, 패킷이 목적지에 도달하지 못했음을 나타냅니다.
</details>
